name: Flutter CI/CD

# Trigger only on PRs to main branch
on:
  pull_request:
    branches:
      - main
    types: [synchronize, ready_for_review]

jobs:
  build_test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.3' # your Flutter version

      # 3Ô∏è‚É£ Install dependencies
      - name: Install Dependencies
        run: flutter pub get

      # 4Ô∏è‚É£ Format check
      - name: Format Check
        run: flutter format --set-exit-if-changed .

      # 5Ô∏è‚É£ Analyze code
      - name: Analyze Code
        run: flutter analyze

      # 6Ô∏è‚É£ Check for duplicate strings (using `flutter_lints` warnings + custom script)
      - name: Duplicate Strings Check
        run: |
          echo "Checking for duplicate strings..."
          grep -rhoP "['\"](.+?)['\"]" lib/ | sort | uniq -d | tee dup_strings.txt
          if [ -s dup_strings.txt ]; then
            echo "Duplicate strings found!"
            cat dup_strings.txt
            exit 1
          else
            echo "No duplicates found."
          fi

      # 7Ô∏è‚É£ Run tests and generate coverage
      - name: Run Tests
        run: flutter test --coverage

      # 8Ô∏è‚É£ Install lcov for coverage reporting
      - name: Install lcov
        run: sudo apt-get install -y lcov

      # 9Ô∏è‚É£ Generate coverage report
      - name: Generate Coverage Report
        run: |
          genhtml coverage/lcov.info --output-directory coverage/html
          echo "Coverage report generated at coverage/html/index.html"

      # üîü Optional: Fail if coverage < 80%
      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(lcov --summary coverage/lcov.info | grep lines | awk '{print $2}' | tr -d '%')
          echo "Total coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage is below 80%!"
            exit 1
          fi
